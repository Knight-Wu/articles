# 分层
![image](https://user-images.githubusercontent.com/20329409/222394515-43af809b-f865-4a86-8145-968f8780b060.png)

![image](https://user-images.githubusercontent.com/20329409/222394796-11ba8644-de2d-42bf-9473-e258cace83c0.png)

## 分哪几层
![image](https://user-images.githubusercontent.com/20329409/222396839-e1017bd3-2c16-4409-ba27-b9fba740f067.jpeg)

一、数据运营层：ODS（Operational Data Store）
把业务数据拷贝过来，减少后续对业务系统的访问。
</br>
“面向主题的”，数据运营层，也叫ODS层，是最接近数据源中数据的一层，数据源中的数据，经过抽取、洗净、传输，也就说传说中的 ETL 之后，装入本层。本层的数据，总体上大多是按照源头业务系统的分类方式而分类的。
</br>
一般来讲，为了考虑后续可能需要追溯数据问题，因此对于这一层就不建议做过多的数据清洗工作，原封不动地接入原始数据即可，至于数据的去噪、去重、异常值处理等过程可以放在后面的DWD层来做。

二、数据仓库层：DW（Data Warehouse）

数据仓库层是我们在做数据仓库时要核心设计的一层，在这里，从 ODS 层中获得的数据按照主题建立各种数据模型。DW层又细分为 DWD（Data Warehouse Detail）层、DWM（Data WareHouse Middle）层和DWS（Data WareHouse Servce）层。

1. 数据明细层：DWD（Data Warehouse Detail）

该层一般保持和ODS层一样的数据粒度，并且提供一定的数据质量保证。同时，为了提高数据明细层的易用性，该层会采用一些维度退化手法，将维度退化至事实表中，减少事实表和维表的关联。
</br>
另外，在该层也会做一部分的数据聚合，将相同主题的数据汇集到一张表中，提高数据的可用性，后文会举例说明。

2. 数据中间层：DWM（Data WareHouse Middle）

该层会在DWD层的数据基础上，对数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。
</br>
直观来讲，就是对通用的核心维度进行聚合操作，算出相应的统计指标。

3. 数据服务层：DWS（Data WareHouse Servce）

又称数据集市或宽表。按照业务划分，如流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等。
</br>
一般来讲，该层的数据表会相对比较少，一张表会涵盖比较多的业务内容，由于其字段较多，因此一般也会称该层的表为宽表。
</br>
在实际计算中，如果直接从DWD或者ODS计算出宽表的统计指标，会存在计算量太大并且维度太少的问题，因此一般的做法是，在DWM层先计算出多个小的中间表，然后再拼接成一张DWS的宽表。由于宽和窄的界限不易界定，也可以去掉DWM这一层，只留DWS层，将所有的数据在放在DWS亦可。

三、数据应用层：APP（Application）

在这里，主要是提供给数据产品和数据分析使用的数据，一般会存放在 ES、PostgreSql、Redis等系统中供线上系统使用，也可能会存在 Hive 或者 Druid 中供数据分析和数据挖掘使用。比如我们经常说的报表数据，一般就放在这里。

四、维表层（Dimension）

最后补充一个维表层，维表层主要包含两部分数据：
</br>
高基数维度数据：一般是用户资料表、商品资料表类似的资料表。数据量可能是千万级或者上亿级别。
</br>
低基数维度数据：一般是配置表，比如枚举值对应的中文含义，或者日期维表。数据量可能是个位数或者几千几万。

## 参考
1. https://cloud.tencent.com/developer/article/1396891

## 简要概括

![image](https://user-images.githubusercontent.com/20329409/222394754-e78a9da5-90a3-4b59-b5fc-931e21677b48.jpeg)


例如电商系统中，用户访问日志这一部分数据。

在ODS层中，由于各端的开发团队不同或者各种其它问题，用户的访问日志被分成了好几张表上报到了我们的ODS层。
</br>
为了方便大家的使用，我们在DWD层做了一张用户访问行为天表，在这里，我们将PC网页、H5、小程序和原生APP访问日志汇聚到一张表里面，统一字段名，提升数据质量，这样就有了一张可供大家方便使用的明细表了。
</br>
在DWM层，我们会从DWD层中选取业务关注的核心维度来做聚合操作，比如只保留人、商品、设备和页面区域维度。类似的，我们这样做了很多个DWM的中间表
</br>
然后在DWS层，我们将一个人在整个网站中的行为数据放到一张表中，这就是我们的宽表了，有了这张表，就可以快速满足大部分的通用型业务需求了。
</br>
最后，在APP应用层，根据需求从DWS层的一张或者多张表取出数据拼接成一张应用表即可

## 分层的好处
1. 清晰数据结构：每一个数据分层都有它的作用域和职责，在使用表的时候能更方便地定位和理解
2. 减少重复开发：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算
3。 统一数据口径：通过数据分层，提供统一的数据出口，统一对外输出的数据口径
4. 复杂问题简单化：将一个复杂的任务分解成多个步骤来完成，每一层解决特定的问题
## 为什么要分层
1. 对应用的支持上来讲，越上层对应用越友好，越底层理解成本越高
2. 从能力范围来讲，80%的需求由20%的表来支持，大部分需求由DWS 的表支持，对于80%的需求都希望以对应用友好的方式来支持，而不是暴露给应用方原始日志的方式。
3. 从数据聚合的角度，越上层的数据聚合程度越高，可以理解为每行数据包含的信息越多，纬度越少，由多个底层数据聚合而成。ODS和DWD的数据基本是原始日志的粒度，不做任何聚合操作，DWM做了轻度的聚合操作只保留了通用的维度，DWS做了更高的聚合操作，可能只保留一到两个能表征当前描述主体的维度。从这个角度来看，我们又可以理解为我们是按照数据的聚合程度来划分数据层次的。
