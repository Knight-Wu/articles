# 怎么保证日志不漏采集, 保证不了不重复

## INotify + 轮训 保证能监听到文件的新增和改动

轮训是一个兜底的方式, INotify 可能某些场景有遗漏, 
* inode 在不同时刻重用的问题咋解决的呀, 这一时刻用着inode 是1, 文件被删了, 然后新创建的inode 又是1, 这种情况咋解决的

可以对于每个文件的前128B生成一个hash值，作为这个文件多一个维度的标识

* 文件被采集之前被删除的情况呢

INotify 能感知文件的新增, 文件新增时就立马open, 保证对这个文件的引用, 只要进程对文件的引用不为零就不会被OS 回收, 真正删除

## 保留每个文件采集到的offset , 类似checkpoint
key 是deviceName + INode Id, 因为INode Id 只在单个文件系统内唯一, val 是offset , 采集到的文件字节数; 因为这个更新是延迟更新, 定期保存在本地或者发送到远程存储, 肯定有延迟, 
在读取文件内容未发送之前, 突然程序中断, 就会导致数据重复

## 采集器数据链路上的内部组件都保证优雅关闭, 可以减少重复
