
## 网络代理分层

要聊几层代理，需要先看一下网络分层，在之前的文章中也提到，标准的七层网络分层，也就是OSI七层模型。TCP/IP五层模型和TCP/IP四层模型是从OSI七层优化而来。
这里所谈的四层代理和七层代理，便是基于OSI七层模型来划分的。
![image](https://github.com/Knight-Wu/articles/assets/20329409/b4330a99-aab7-4c97-9e20-1c8deba23f0b)

从下往上看，第四层为传输层、第七层为应用层。再来看看每层对应的常见协议：


![image](https://github.com/Knight-Wu/articles/assets/20329409/db211ad0-018f-4a04-87ce-2e92639950e7)

四层对应的是TCP/UDP协议，也就常说的IP+端口。七层已经是非常具体的应用层协议了。因此，所谓四层就是基于IP+端口的负载均衡；七层就是基于URL等应用层信息的负载均衡；

同理，还有基于MAC地址的二层负载均衡和基于IP地址的三层负载均衡。二层负载均衡通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；三层负载均衡通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址。

### 四层代理
四层代理主要工作于OSI模型中的传输层，传输层主要处理消息的传递，而不管消息的内容。TCP就是常见的四层协议。

四层负载均衡只针对由上游服务发送和接收的网络包，而并不检查包内的具体内容是什么。四层负载均衡可以通过检查TCP流中的前几个包，从而决定是否限制路由。

因此，四层负载均衡的核心就是IP+端口层面的负载均衡，不涉及具体的报文内容。

### 七层代理
七层代理主要工作于OSI模型的应用层，应用层主要用来处理消息内容的。比如，HTTP便是常见的七层协议。

七层负载均衡服务器起到了反向代理的作用，Client端要先与七层负载均衡设备三次握手建立TCP连接，把要访问的报文信息发送给七层负载均衡。

七层负载均衡器基于消息中内容( 比如URL或者cookie中的信息 )来做出负载均衡的决定。之后，七层负载均衡器建立一个新的TCP连接来选择上游服务并向这个服务发出请求。

使用七层负载均衡的设备经常被用于反向代理。

### 四层代理和七层代理的区别
![image](https://github.com/Knight-Wu/articles/assets/20329409/9c54f239-6c02-42c2-8a65-4fefaa38b8ae)

上图中最直观的区别是四层代理只进行了一次TCP请求，而七层代理进行了两次TCP请求。

四层代理：四层代理拆解报文至传输层，根据请求的服务器IP+端口号进行转发；四层代理是由后端服务器进行处理，包括报文的封装都是后端服务器进行封装；四层代理相当于是一个路由器。

七层代理：七层代理拆解报文至应用层，分析用户请求的资源，然后负载均衡器会代替用户请求后端服务器的资源；后端服务器把资源返回给负载均衡器，负载均衡器对资源再次进行封装，然后返还给客户端；在此过程中，需要建立两次TCP连接，一次是客户端，一次是后端的服务器。

七层负载均衡的CPU密集程度比基于包的四层负载均衡更高。七层负载均衡能够让均衡器做更小粒度的负载均衡决定，并且会根据消息的内容( 比如压缩和加密 )利用最优化方式做出改变。它运用缓存的方式来卸载上游服务较慢的连接，并显著地提高了性能。

### 负载均衡器
负载均衡器通常称为四层交换机或七层交换机。四层交换机主要分析IP层及TCP/UDP层，实现四层流量负载均衡。七层交换机除了支持四层负载均衡以外，还有分析应用层的信息，如HTTP协议URI或Cookie信息。

负载均衡分为L4 switch（四层交换），即在OSI第4层工作，也就是TCP层。四层负载均衡器（如：LVS，F5）不关心应用协议（如HTTP/FTP/MySQL等）。

L7 switch（七层交换），OSI的最高层，应用层。七层负载均衡器（如： HAProxy，MySQL Proxy）能理解应用协议。

Nginx、LVS、HAProxy是目前使用最广泛的三种负载均衡软件。

### nginx
Nginx 是一种通常被用作七层（应用层）负载均衡器的软件，尤其常见于处理 HTTP 和 HTTPS 协议的流量。它可以根据 HTTP 请求的内容（例如，URL、HTTP 头部等）来决定将流量路由到哪个后端服务器。这种能力使得 Nginx 能够执行复杂的负载分发决策，例如基于内容的路由。

然而，除了作为一个应用层的负载均衡器外，Nginx 也可以在四层（传输层）进行负载均衡。Nginx 有一个叫做 Stream 模块的功能，可以处理基于 TCP 和 UDP 的流量。通过这个模块，Nginx 可以根据源 IP 地址和端口号或者目标 IP 地址和端口号来决定将流量路由到哪个后端服务器。

### 七层和四层代理的应用场景
七层负载均衡器可以是使整个网络更智能化，比如可以通过七层代理将图片类、静态文件类（JS、CSS）请求转发到特定的服务器，利用缓存技术达到更好的性能。

从技术原理上，可以对客户端的请求和服务器的响应进行任意意义上的修改，极大的提升了应用系统在网络层的灵活性。例如Nginx或者Apache上部署的功能可以前移到负载均衡设备上，例如客户请求中的Header重写，服务器响应中的关键字过滤或者内容插入等功能。

针对SYN Flood攻击，四层模型下攻击请求会被转发到后端服务器上，而七层模式下则可在负载均衡器上进行拦截，不影响后台服务器正常运营。针对SQL注入等情况，也可以通过在七层代理设置策略进行特定报文的过滤，从应用层面进一步提高系统整体安全。

总之，七层负载均衡，主要着重于应用HTTP协议，所以其应用范围主要是对外的网站.
四层负载均衡则对应其他内部的TCP应用，例如基于C/S开发的ERP等系统。

与七层负载均衡相比，四层负载均衡的功能可能相对较少，但其处理速度通常更快，延迟更低，因为它们只需要处理较少的信息就可以做出决策。在处理大量基于TCP或UDP的流量时，四层负载均衡是一个非常有效的解决方案。

## DDOS 攻击
可以按照网络七层架构攻击不同的层, 常见的是攻击传输层 tcp 层, 通过在用户手机植入病毒然后模拟发送请求(但是如何绕过验证码), 然后立马断开请求, 模拟 TCP 建立链接的过程, 大量建立并断开 tcp 连接.
不能通过抓包去模拟请求, 因为多数是 https, 通过 tls 加密http 层的报文, 虽然可以通过网络流量看到向某个域名端口发送报文, 但是报文是加密的, 无法窃取, 篡改里面的信息, 如果要隐藏ip 端口等, 需要 VPN 虚拟专用网络. 


## 如何防止 DDOS
一般通过七层代理, 在第一层网关服务器(通常是开源的 Nginx 通过配置设置一些路由规则) 进行硬抗这大量的 tcp 建立和断开的过程, 识别一些访问次数过多的 IP, 并直接拦截, 保证正常请求仍然能建立正常的 tcp 连接并能转发到下层网关服务器, 不影响正常请求. 

